#!/usr/bin/env python3
"""SMB session â€” connect to target.

Usage: python smb_session.py <host> <port>

Connects with null credentials and opens a console pipe.
Everything you see comes from the target. This script just
forwards text.
"""

import sys

from impacket.smbconnection import SMBConnection

if len(sys.argv) != 3:
    print(f"Usage: {sys.argv[0]} <host> <port>")
    sys.exit(1)

host, port = sys.argv[1], int(sys.argv[2])

conn = SMBConnection(host, host, sess_port=port)
conn.login("", "")

tid = conn.connectTree("IPC$")
fid = conn.openFile(tid, "\\console")

# Read and display whatever the server sends
data = conn.readFile(tid, fid, 0, 4096)
if data:
    print(data.decode("utf-8", errors="replace"), end="", flush=True)

try:
    while True:
        cmd = input()
        conn.writeFile(tid, fid, (cmd + "\n").encode("utf-8"), 0)
        data = conn.readFile(tid, fid, 0, 4096)
        if data:
            print(data.decode("utf-8", errors="replace"), end="", flush=True)
        else:
            break
except (EOFError, KeyboardInterrupt, Exception):
    pass
finally:
    conn.close()